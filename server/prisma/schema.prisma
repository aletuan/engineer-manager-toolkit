// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Core Entities
model User {
  id           String         @id @default(uuid())
  email        String        @unique
  passwordHash String
  squadMember  SquadMember?
  tasks        Task[]        @relation("CreatedBy")
  taskNotes    TaskNote[]
  activityLogs ActivityLog[]
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@map("users")
}

model Squad {
  id              String            @id @default(uuid())
  name            String
  code            String            @unique
  description     String?
  members         SquadMember[]
  tasks           Task[]
  incidentRotations IncidentRotation[]
  sprintReports   SprintReport[]
  roleAssignments RoleAssignment[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@map("squads")
}

model SquadMember {
  id                String            @id @default(uuid())
  squadId          String
  userId           String            @unique
  pid              String            @unique
  fullName         String
  email            String
  phone            String
  position         String
  avatarUrl        String?
  status           MemberStatus      @default(ACTIVE)
  squad            Squad             @relation(fields: [squadId], references: [id])
  user             User              @relation(fields: [userId], references: [id])
  taskAssignments  TaskAssignee[]
  primaryRotations IncidentRotation[] @relation("PrimaryMember")
  secondaryRotations IncidentRotation[] @relation("SecondaryMember")
  requestedSwaps   RotationSwap[]    @relation("Requester")
  acceptedSwaps    RotationSwap[]    @relation("Accepter")
  roleAssignments  RoleAssignment[]
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  @@map("squad_members")
}

model Stakeholder {
  id           String            @id @default(uuid())
  code         String            @unique
  name         String
  description  String?
  contactName  String
  contactEmail String
  contactPhone String
  groupName    String
  tasks        TaskStakeholder[]
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@map("stakeholders")
}

model Task {
  id          String       @id @default(uuid())
  title       String
  description String
  status      TaskStatus   @default(TODO)
  priority    TaskPriority @default(MEDIUM)
  dueDate     DateTime
  assignedTo  User         @relation("AssignedTasks", fields: [assignedToId], references: [id])
  assignedToId String
  createdBy   User         @relation("CreatedTasks", fields: [createdById], references: [id])
  createdById String
  project     Project      @relation(fields: [projectId], references: [id])
  projectId   String
  tags        String[]
  attachments Json
  comments    TaskComment[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@index([assignedToId])
  @@index([createdById])
  @@index([projectId])
}

// Supporting Entities
model TaskAssignee {
  taskId    String
  memberId  String
  role      AssigneeRole
  task      Task        @relation(fields: [taskId], references: [id])
  member    SquadMember @relation(fields: [memberId], references: [id])
  createdAt DateTime    @default(now())

  @@id([taskId, memberId])
  @@map("task_assignees")
}

model TaskStakeholder {
  taskId       String
  stakeholderId String
  task         Task       @relation(fields: [taskId], references: [id])
  stakeholder  Stakeholder @relation(fields: [stakeholderId], references: [id])
  createdAt    DateTime    @default(now())

  @@id([taskId, stakeholderId])
  @@map("task_stakeholders")
}

model TaskDependency {
  taskId           String
  dependentTaskId  String
  dependencyType   DependencyType
  task             Task          @relation("DependentTask", fields: [taskId], references: [id])
  dependentTask    Task          @relation("BlockingTask", fields: [dependentTaskId], references: [id])
  createdAt        DateTime      @default(now())

  @@id([taskId, dependentTaskId])
  @@map("task_dependencies")
}

model TaskNote {
  id        String   @id @default(uuid())
  taskId    String
  authorId  String
  content   String
  task      Task     @relation(fields: [taskId], references: [id])
  author    User     @relation(fields: [authorId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("task_notes")
}

model IncidentRotation {
  id                String      @id @default(uuid())
  squadId           String
  primaryMemberId   String
  secondaryMemberId String
  startDate         DateTime
  endDate           DateTime
  sprintNumber      Int
  squad             Squad       @relation(fields: [squadId], references: [id])
  primaryMember     SquadMember @relation("PrimaryMember", fields: [primaryMemberId], references: [id])
  secondaryMember   SquadMember @relation("SecondaryMember", fields: [secondaryMemberId], references: [id])
  swaps             RotationSwap[]
  createdAt         DateTime    @default(now())

  @@map("incident_rotations")
}

model RotationSwap {
  id           String           @id @default(uuid())
  rotationId   String
  requesterId  String
  accepterId   String
  swapDate     DateTime
  status       SwapStatus       @default(PENDING)
  rotation     IncidentRotation @relation(fields: [rotationId], references: [id])
  requester    SquadMember      @relation("Requester", fields: [requesterId], references: [id])
  accepter     SquadMember      @relation("Accepter", fields: [accepterId], references: [id])
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@map("rotation_swaps")
}

// Monitoring & Analytics
model ActivityLog {
  id         String   @id @default(uuid())
  userId     String
  entityType String
  entityId   String
  action     String
  details    Json
  user       User     @relation(fields: [userId], references: [id])
  createdAt  DateTime @default(now())

  @@map("activity_logs")
}

model SprintReport {
  id                 String   @id @default(uuid())
  squadId            String
  sprintNumber       Int
  startDate          DateTime
  endDate            DateTime
  totalPoints        Int
  completedPoints    Int
  memberMetrics      Json
  stakeholderMetrics Json
  squad              Squad    @relation(fields: [squadId], references: [id])
  createdAt          DateTime @default(now())

  @@map("sprint_reports")
}

// Enums
enum MemberStatus {
  ACTIVE
  INACTIVE
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

enum AssigneeRole {
  PRIMARY
  SECONDARY
}

enum DependencyType {
  BLOCKS
  BLOCKED_BY
}

enum SwapStatus {
  PENDING
  APPROVED
  REJECTED
}

model Role {
  id          String           @id @default(uuid())
  name        String           @unique
  description String
  permissions String[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  assignments RoleAssignment[]

  @@map("roles")
}

model RoleAssignment {
  id        String       @id @default(uuid())
  squad     Squad        @relation(fields: [squadId], references: [id])
  squadId   String
  member    SquadMember  @relation(fields: [memberId], references: [id])
  memberId  String
  role      Role         @relation(fields: [roleId], references: [id])
  roleId    String
  assignedAt DateTime    @default(now())
  assignedBy String
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([squadId, memberId, roleId])
  @@map("role_assignments")
}

model TaskComment {
  id        String   @id @default(uuid())
  content   String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String
  createdBy User     @relation(fields: [createdById], references: [id])
  createdById String
  createdAt DateTime @default(now())

  @@index([taskId])
  @@index([createdById])
} 